# ------------------------------------------------------------
# {{ domain_names | join: ", " }}
# ------------------------------------------------------------

{% if enabled %}

server {
  set $forward_scheme {{ forward_scheme }};
  set $server "{{ forward_host }}";
  set $port {{ forward_port }};

  server_name {{ domain_names | join: " " }};

  # HTTP listener
  listen 80;
  listen [::]:80;

  {% if certificate_id > 0 %}
  # HTTPS listener
  listen 443 ssl;
  listen [::]:443 ssl;

  # SSL Certificate
  {% if certificate.provider == "letsencrypt" %}
  ssl_certificate /data/letsencrypt/live/npm-{{ certificate_id }}/fullchain.pem;
  ssl_certificate_key /data/letsencrypt/live/npm-{{ certificate_id }}/privkey.pem;
  {% else %}
  ssl_certificate /data/custom_ssl/npm-{{ certificate_id }}/fullchain.pem;
  ssl_certificate_key /data/custom_ssl/npm-{{ certificate_id }}/privkey.pem;
  {% endif %}

  # Force SSL
  {% if ssl_forced == 1 %}
  if ($scheme = "http") {
    return 301 https://$host$request_uri;
  }
  {% endif %}

  # HSTS
  {% if hsts_enabled == 1 %}
  add_header Strict-Transport-Security "max-age=31536000{% if hsts_subdomains == 1 %}; includeSubDomains{% endif %}; preload" always;
  {% endif %}
  {% endif %}

  {% if brotli_enabled == true %}
  # Brotli compression (requires ngx_brotli)
  brotli on;
  brotli_comp_level 5;
  brotli_static on;
  brotli_types text/plain text/css text/xml application/javascript application/json application/xml application/rss+xml application/atom+xml image/svg+xml font/ttf font/otf;
  {% endif %}

  {% if security_headers_enabled == true %}
  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  {% endif %}

  # Global path block include (managed by /api/security)
  include /data/nginx/security_path_block.conf;

  # ACME Challenge
  location /.well-known/acme-challenge/ {
    root /tmp/acme-challenge;
    allow all;
  }

  # Bot control: whitelist search/SNS bots, block bad/AI bots, optional challenge redirect
  {% assign bot_block_flag = bot_block_enabled | default: 0 %}
  {% assign bot_challenge_flag = bot_challenge_enabled | default: 0 %}
  {% assign bot_block = bot_block_flag == 1 %}
  {% assign bot_challenge = bot_challenge_flag == 1 %}
  {% if bot_block %}
  # Serve captcha/verify via backend
  location = /captcha.html {
    proxy_pass http://127.0.0.1:3000/api/security/captcha?id={{ id }};
    proxy_set_header Host $host;
  }

  location = /bot-verify {
    proxy_pass http://127.0.0.1:3000/api/security/verify;
    proxy_set_header Host $host;
  }
  {% endif %}

  {% assign geoip_total = geoip_allow_countries.size | plus: geoip_deny_countries.size %}
  {% assign geoip_enabled = geoip_total > 0 %}
  
  {% assign access_check_enabled = false %}
  {% if geoip_enabled or bot_block %}
    {% assign access_check_enabled = true %}
  {% endif %}

  {% if access_check_enabled %}
  # Access check auth subrequest (GeoIP + Bot)
  location = /_access_check_{{ id }} {
    internal;
    proxy_pass http://127.0.0.1:3000/api/geoip/check?id={{ id }};
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  {% endif %}

  # ModSecurity WAF
  {% if waf_enabled == 1 or waf_enabled == true %}
  modsecurity {{ waf_mode }};
  modsecurity_rules_file /etc/nginx/modsec/main.conf;
  
  # Global WAF rules (managed by /api/security)
  modsecurity_rules_file /data/nginx/security_waf_rules.conf;
  
  # Set paranoia level via SecAction
  modsecurity_rules '
    SecAction "id:900000,phase:1,nolog,pass,t:none,setvar:tx.paranoia_level={{ waf_paranoia_level }}"
  ';
  {% endif %}

  # Block exploits
  {% if block_exploits == 1 %}
  # Block hidden files
  location ~* /\\.ht {
    deny all;
  }
  location ~* /\\.git {
    deny all;
  }
  location ~* /\\.svn {
    deny all;
  }
  location ~* /\\.env {
    deny all;
  }
  
  # Block SQL injection attempts
  if ($query_string ~* "union.*select.*\(") { return 403; }
  if ($query_string ~* "union.*all.*select.*") { return 403; }
  if ($query_string ~* "concat.*\(") { return 403; }
  
  # Block XSS attempts
  if ($query_string ~* "(<|%3C).*script.*(>|%3E)") { return 403; }
  if ($query_string ~* "GLOBALS(=|\\[|%[0-9A-Z]{0,2})") { return 403; }
  if ($query_string ~* "_REQUEST(=|\\[|%[0-9A-Z]{0,2})") { return 403; }
  
  # Block path traversal
  if ($query_string ~* "\\.\\./") { return 403; }
  if ($query_string ~* "\\.\\.\\\\") { return 403; }
  if ($request_uri ~* "\\.\\./") { return 403; }
  
  # Block file injection
  if ($query_string ~* "proc/self/environ") { return 403; }
  if ($query_string ~* "mosConfig_[a-zA-Z_]{1,21}(=|\\%3D)") { return 403; }
  if ($query_string ~* "base64_(en|de)code\\(.*\\)") { return 403; }
  
  # Block common exploit patterns
  if ($http_user_agent ~* "(nmap|nikto|wikto|sf|sqlmap|bsqlbf|w3af|acunetix|havij|appscan)") { return 403; }
  if ($http_user_agent ~* "(libwww-perl|python|curl|wget)") { return 403; }
  
  # Block suspicious request methods
  if ($request_method ~* "^(TRACE|DELETE|TRACK)$") { return 403; }
  {% endif %}

  # Access log
  access_log /data/logs/proxy-host-{{ id }}_access.log monitor;
  error_log /data/logs/proxy-host-{{ id }}_error.log warn;

  # Advanced config
  {{ advanced_config }}

  # Caching
  {% if caching_enabled %}
  proxy_cache my_cache;
  proxy_cache_valid 200 302 10m;
  proxy_cache_valid 404 1m;
  {% endif %}

  # Default location
  location / {
    {% if access_check_enabled %}
    auth_request /_access_check_{{ id }};
    {% endif %}
    proxy_pass {{ forward_scheme }}://{{ forward_host }}:{{ forward_port }};
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # WebSocket Support
    {% if allow_websocket_upgrade %}
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    {% endif %}
  }

  # Custom Locations
  {% for location in custom_locations %}
  location {{ location.path }} {
    {% if access_check_enabled %}
    auth_request /_access_check_{{ id }};
    {% endif %}
    proxy_pass {{ location.forward_scheme }}://{{ location.forward_host }}:{{ location.forward_port }};
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    {{ location.advanced_config }}
  }
  {% endfor %}
}

{% endif %}
